# 0431_交流

## **明晰了区块内部结构以及区块底层的一些操作**

1. 创世块增加position core/genesis.go type GenesisAccount struct {}

   创世块写入数据库func (g *Genesis) ToBlock(db ethdb.Database) *types.Block
   
   存储创世块中的账户位置 statedb.SetPosition(addr, account.Position)
2. account添加position internal/ethapi/api.go
   
   获得账户位置GetPosition internal/ethapi/api.go
3. transaction添加position core\types\transaction.go
4. 添加账户位置树 core/state_transition.go
5. 添加区域状态树 /gtrie

   添加区域状态数据库，缓存区域状态 regionstate,RStateDB core/regionstate/

   miner添加区域状态信息 miner/worker.go makeCurrent

   增加rstate功能 common/types.go

   state_object.go、statedb.go 添加 SetAccountlist,SetTxlist,SetRplist,Set URRlist设定指定区域状态内容
6. 添加树状属性 core/types/block.go type Header struct{}
7. 增加分支同步方式 eth/downloader/modes.go BranchSync
8. 节点中记录分支区块 core/blockchain.go type BlockChain struct{}
9. 分支节点可以生成分支区块 internal/jsre/deps/web3.js var setBranchblock = new Method{}
10. 分支区块写入区块链 internal/ethapi/api.go SetBranchBlock -> core/blockchain.go SetBranchBlockByRegion
11. 根据regionid同步区块 eth/sync.go synchronise(peer *peer){}
12. 为branchnode构建mrgionstate,mgtrie core/mrgionstate,mgtrie
13. 为branchnode建立 getaccountbyregion,gettxbyregion,getreceiptbyregion方法 (api.go)
14. branchnode管理资产转移列表 core/asset_transfer_list.go
15. 交易增加txtype属性 core/types/transaction.go type txdata struct{}
16. branchnode根据交易类型筛选 收到的交易 eth/handler.go-> handleMsg->NewBlockMsg

## **明晰了分支节点间的资产转移的过程**

1. 分支节点根据regionid同步区块，收到handleMsg的信息
2. 交易增加txtype属性，用来记录对资产转移的状态做记录
3. 根据收到的NewBlockMsg将对应的资产转移添加进asset_transfer_list（维护资产转移操作的原子性）
4. 等到该转移返回信息为成功后，移出交易池


## **真实地图数据处理**
具体流程参考了[如何获取真实的地图数据，并将其转化为区块链上可用的地图数据](https://gitee.com/lancerenk/graduation-design/blob/master/RealBjMap/%E5%9C%B0%E5%9B%BE%E6%95%B0%E6%8D%AE%E8%AF%B4%E6%98%8E/%E8%8E%B7%E5%8F%96%E7%9C%9F%E5%AE%9E%E5%9C%B0%E5%9B%BE%E6%95%B0%E6%8D%AE.md)

**整体的流程**：

1. 把地图的原始数据导入数据库里
2. 在数据库里进行清洗和筛选
3. 筛选出的数据导出为json文件格式
4. 用脚本对json文件进行处理，得到最终的地图数据

## **可用的乘客和车辆位置选取**
按计划需要在现有wx4e的地图基础上选点进行路线测试，本人计划选点公交车的站点进行测试，看会不会遇到之前的bug
